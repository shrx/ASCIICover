#!/bin/bash

# released under Creative Commons Attribution-ShareAlike 3.0
# http://creativecommons.org/licenses/by-sa/3.0/
# v1.3
# 20. 2. 2012
# dependencies: libcaca, mpc, mpd

rflag=

while getopts r name
do
    case $name in
    r)    rflag=1;;
    ?)   printf "Usage: %s:\nResize window: [-r]\n" $0
          exit 2;;
    esac
done

function ascii {
	path=$(mpc -f %file% current)
	lib1=$(grep -a -m 1 music_directory ~/.mpdconf)
	lib2=$(echo ${lib1%\"*})
	librarypath=$(echo ${lib2#*\"})
	dirpath=$(dirname "$path")
	fullpath=$(echo $librarypath"/"$dirpath)
	folderpath=$(echo $fullpath"/folder.jpg")
	lines=$(tput lines)
	height=$(echo "$lines-1"|bc)
	width=$(echo "$height*1.87"|bc)
	if [ -f "$folderpath" ]; then
		art=$(img2txt -H $height -W $width --dither none "$folderpath")
		echo "$art"
	else
		clear
	fi
}

clear
printf "\033]2;ASCIICover\007"
QQUIT="no"
read -s -t 1 -n 1 QQUIT
terminal=$(echo $TERM_PROGRAM)
if [ ! -z "$rflag" ]; then
	if [ "$terminal" == "iTerm.app" ]; then
		osascript -e 'tell app "iterm" to set the bounds of the first window to {140, 120, 140+400-12, 120+400+20}'
	else
		printf "\033[4;388;423t"
	fi
fi
ascii
cols=$(tput cols)
while [ "$QQUIT" != "q" ]; do
	if [[ "$(dirname "$(mpc -f %file% current)")" != "$dirpath" || "$(tput lines)" != "$lines" || "$(tput cols)" != "$cols" ]]; then
		ascii
		cols=$(tput cols)
	elif [ -z "$(mpc current)" ]; then
		clear
	else
		echo "$art"
	fi
	sleep 1
	read -s -t 1 -n 1 QQUIT
done
printf "\033]2;\007"
clear
exit